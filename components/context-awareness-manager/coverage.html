
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>handlers: Go Coverage Report</title>
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">context-awareness-manager/api/handlers/handler.go (53.6%)</option>
				
				<option value="file1">context-awareness-manager/cmd/context-awareness-manager/main.go (0.0%)</option>
				
				<option value="file2">context-awareness-manager/docs/docs.go (100.0%)</option>
				
				<option value="file3">context-awareness-manager/internal/monitor/monitor.go (76.6%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">/*
COLMENA-DESCRIPTION-SERVICE
Copyright © 2024 EVIDEN

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

This work has been implemented within the context of COLMENA project.
*/
package handlers

import (
        "context-awareness-manager/internal/models"
        "context-awareness-manager/internal/monitor"
        "database/sql"
        "encoding/json"
        "fmt"
        "log"
        "net/http"
)

// @Summary Receive context
// @Description Endpoint to receive and process Docker context
// @Tags Context
// @Accept  json
// @Produce json
// @Param context body models.Context true "Context to process"
// @Success 200 {object} models.Result "Context processed successfully"
// @Failure 400 {string} string "Invalid context"
// @Router /context [post]
func HandleContext(w http.ResponseWriter, r *http.Request, db *sql.DB) <span class="cov8" title="1">{
        if r.Method != http.MethodPost </span><span class="cov0" title="0">{
                http.Error(w, "Invalid request method", http.StatusMethodNotAllowed)
                return
        }</span>

        <span class="cov8" title="1">var ctx models.ServiceDescription
        // Decode the JSON request body
        err := json.NewDecoder(r.Body).Decode(&amp;ctx)
        if err != nil </span><span class="cov0" title="0">{
                http.Error(w, "Failed to decode JSON", http.StatusBadRequest)
                log.Printf("Failed to decode JSON: %v", err)
                return
        }</span>

        // Insert new context into the database
        <span class="cov8" title="1">for _, context := range ctx.DockerContextDefinitions </span><span class="cov8" title="1">{
                _, err = db.Exec(`INSERT OR REPLACE INTO dockerContextDefinitions (id, imageId) VALUES (?, ?)`, context.ID, context.ImageID)
                if err != nil </span><span class="cov0" title="0">{
                        log.Printf("Failed to save context response for ID %s: %v", context.ID, err)
                        return
                }</span>
                //LLamar al Container Engine SDK para ejecutar la imagen y que nos devuelva la clasificacion
                <span class="cov8" title="1">classification, err := monitor.DeployContainer(context.ImageID, nil)
                if err != nil </span><span class="cov0" title="0">{
                        log.Printf("Error deploying container: %v\n", err)
                        return
                }</span>
                <span class="cov8" title="1">log.Printf("Context classification: %s\n", classification)</span>
        }

        // Insert new role into the database
        <span class="cov8" title="1">for _, role := range ctx.DockerRoleDefinitions </span><span class="cov0" title="0">{
                _, err = db.Exec(`INSERT OR REPLACE INTO dockerRoleDefinitions (id, imageId) VALUES (?, ?)`, role.ID, role.ImageID)
                if err != nil </span><span class="cov0" title="0">{
                        log.Printf("Failed to save role response for ID %s: %v", role.ID, err)
                        return
                }</span>
        }

        // Respond with a success message
        <span class="cov8" title="1">w.WriteHeader(http.StatusOK)
        fmt.Fprintf(w, "Context received: %+v\n", ctx)</span>
}

// HealthHandler checks if the service is up and running.
// @Summary Check API health
// @Description Checks if the service is up and responding.
// @Tags Health
// @Produce text/plain
// @Success 200 {string} string "OK"
// @Router /health [get]
func HealthHandler(w http.ResponseWriter, r *http.Request) <span class="cov8" title="1">{
        w.WriteHeader(http.StatusOK)
        fmt.Fprintln(w, "Context Awareness Manager API is running. Publish new context to /context path")
}</span>
</pre>
		
		<pre class="file" id="file1" style="display: none">/*
  COLMENA-DESCRIPTION-SERVICE
  Copyright © 2024 EVIDEN

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

  This work has been implemented within the context of COLMENA project.
*/

package main

import (
        "context-awareness-manager/api/handlers"
        "context-awareness-manager/internal/models"
        "context-awareness-manager/internal/monitor"
        "database/sql"
        "fmt"
        "log"
        "net/http"
        "time"

        _ "context-awareness-manager/docs"

        _ "github.com/mattn/go-sqlite3"
        httpSwagger "github.com/swaggo/http-swagger"
)

// @title Context Awareness Manager API
// @version 1.0
// @description API API for managing Docker context and roles in the COLMENA project.
// @termsOfService http://swagger.io/terms/

// @contact.name API Support
// @contact.url http://www.swagger.io/support
// @contact.email support@swagger.io

// @license.name Apache 2.0
// @license.url http://www.apache.org/licenses/LICENSE-2.0.html

// @host localhost:8000
// @BasePath /

// @securityDefinitions.apikey Bearer
// @in header
// @name Authorization
// @description "Type 'Bearer TOKEN' to correctly set the API Key"

// @externalDocs.description OpenAPI
// @externalDocs.url https://swagger.io/resources/open-api/

func main() <span class="cov0" title="0">{
        // Create and initialize the database
        db, err := sql.Open("sqlite3", "./context_awareness_manager.db")
        if err != nil </span><span class="cov0" title="0">{
                log.Fatal(err)
        }</span>
        <span class="cov0" title="0">defer db.Close()

        // Create the contexts table if it doesn't exist
        _, err = db.Exec(`CREATE TABLE IF NOT EXISTS dockerContextDefinitions (
                id TEXT PRIMARY KEY,
                imageId TEXT NOT NULL
        )`)
        if err != nil </span><span class="cov0" title="0">{
                log.Fatal(err)
        }</span>

        // Create the roles  table if it doesn't exist
        <span class="cov0" title="0">_, err = db.Exec(`CREATE TABLE IF NOT EXISTS dockerRoleDefinitions (
                id TEXT PRIMARY KEY,
                imageId TEXT NOT NULL
        )`)
        if err != nil </span><span class="cov0" title="0">{
                log.Fatal(err)
        }</span>

        <span class="cov0" title="0">http.HandleFunc("/health", handlers.HealthHandler)
        http.HandleFunc("/context", func(w http.ResponseWriter, r *http.Request) </span><span class="cov0" title="0">{
                handlers.HandleContext(w, r, db)
        }</span>)
        // Swagger documentation endpoint
        <span class="cov0" title="0">http.HandleFunc("/swagger/", httpSwagger.WrapHandler)

        interval := 30 * time.Second

        // Channel to receive the monitoring results
        resultChannel := make(chan models.Result)

        // Goroutine to check if DockerContextDefinitions table has data and start monitoring
        go func() </span><span class="cov0" title="0">{
                for </span><span class="cov0" title="0">{
                        contextList, err := monitor.GetContextData(db)
                        if err != nil </span><span class="cov0" title="0">{
                                log.Printf("Error checking context data: %v", err)
                                time.Sleep(10 * time.Second)
                                continue</span>
                        }
                        <span class="cov0" title="0">if len(contextList) &gt; 0 </span><span class="cov0" title="0">{
                                fmt.Println("Context data found, starting monitoring")
                                go monitor.MonitorContext(interval, contextList, resultChannel)
                                break</span>
                        }
                        <span class="cov0" title="0">time.Sleep(10 * time.Second)</span> // Wait before checking again
                }
        }()

        <span class="cov0" title="0">go func() </span><span class="cov0" title="0">{
                // Listen for changes and print them
                for result := range resultChannel </span><span class="cov0" title="0">{
                        fmt.Printf("Context has changed: %s\n", result.Classification)
                        keyExpression := fmt.Sprintf("dockerContextDefinitions/%s", result.ID)
                        err := monitor.PublishContext(keyExpression, result.Classification)
                        if err != nil </span><span class="cov0" title="0">{
                                fmt.Println("Error publishing context:", err)
                        }</span> else<span class="cov0" title="0"> {
                                fmt.Println("Context published successfully!")
                        }</span>
                }
        }()

        <span class="cov0" title="0">fmt.Println("Starting controller on :8080")
        if err := http.ListenAndServe(":8080", nil); err != nil </span><span class="cov0" title="0">{
                log.Fatalf("Server failed to start: %v", err)
        }</span>
}
</pre>
		
		<pre class="file" id="file2" style="display: none">// Package docs Code generated by swaggo/swag. DO NOT EDIT
package docs

import "github.com/swaggo/swag"

const docTemplate = `{
    "schemes": {{ marshal .Schemes }},
    "swagger": "2.0",
    "info": {
        "description": "{{escape .Description}}",
        "title": "{{.Title}}",
        "termsOfService": "http://swagger.io/terms/",
        "contact": {
            "name": "API Support",
            "url": "http://www.swagger.io/support",
            "email": "support@swagger.io"
        },
        "license": {
            "name": "Apache 2.0",
            "url": "http://www.apache.org/licenses/LICENSE-2.0"
        },
        "version": "{{.Version}}"
    },
    "host": "{{.Host}}",
    "basePath": "{{.BasePath}}",
    "paths": {
        "/": {
            "get": {
                "description": "Returns a welcome message",
                "produces": [
                    "text/plain"
                ],
                "tags": [
                    "General"
                ],
                "summary": "Main welcome route",
                "responses": {
                    "200": {
                        "description": "Welcome",
                        "schema": {
                            "type": "string"
                        }
                    }
                }
            }
        },
        "/context": {
            "post": {
                "description": "Endpoint to receive and process Docker context",
                "consumes": [
                    "application/json"
                ],
                "produces": [
                    "application/json"
                ],
                "tags": [
                    "Context"
                ],
                "summary": "Receive context",
                "parameters": [
                    {
                        "description": "Context to process",
                        "name": "context",
                        "in": "body",
                        "required": true,
                        "schema": {
                            "$ref": "#/definitions/models.Context"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Context processed successfully",
                        "schema": {
                            "$ref": "#/definitions/models.Result"
                        }
                    },
                    "400": {
                        "description": "Invalid context",
                        "schema": {
                            "type": "string"
                        }
                    }
                }
            }
        },
        "/health": {
            "get": {
                "description": "Checks if the service is up and responding.",
                "produces": [
                    "text/plain"
                ],
                "tags": [
                    "Health"
                ],
                "summary": "Check API health",
                "responses": {
                    "200": {
                        "description": "OK",
                        "schema": {
                            "type": "string"
                        }
                    }
                }
            }
        }
    },
    "definitions": {
        "models.Context": {
            "type": "object",
            "properties": {
                "dockerContextDefinitions": {
                    "type": "array",
                    "items": {
                        "$ref": "#/definitions/models.DockerContextDefinition"
                    }
                },
                "dockerRoleDefinitions": {
                    "type": "array",
                    "items": {
                        "$ref": "#/definitions/models.DockerRoleDefinition"
                    }
                },
                "id": {
                    "$ref": "#/definitions/models.ID"
                },
                "kpis": {
                    "type": "array",
                    "items": {
                        "$ref": "#/definitions/models.KPI"
                    }
                }
            }
        },
        "models.DockerContextDefinition": {
            "type": "object",
            "properties": {
                "id": {
                    "type": "string"
                },
                "imageId": {
                    "type": "string"
                }
            }
        },
        "models.DockerRoleDefinition": {
            "type": "object",
            "properties": {
                "hardwareRequirements": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    }
                },
                "id": {
                    "type": "string"
                },
                "imageId": {
                    "type": "string"
                },
                "kpis": {
                    "type": "array",
                    "items": {
                        "$ref": "#/definitions/models.KPI"
                    }
                }
            }
        },
        "models.ID": {
            "type": "object",
            "properties": {
                "value": {
                    "type": "string"
                }
            }
        },
        "models.KPI": {
            "type": "object",
            "properties": {
                "value": {
                    "type": "string"
                }
            }
        },
        "models.Result": {
            "type": "object",
            "properties": {
                "classification": {
                    "type": "string"
                },
                "id": {
                    "type": "string"
                }
            }
        }
    },
    "securityDefinitions": {
        "Bearer": {
            "description": "\"Type 'Bearer TOKEN' to correctly set the API Key\"",
            "type": "apiKey",
            "name": "Authorization",
            "in": "header"
        }
    },
    "externalDocs": {
        "description": "OpenAPI",
        "url": "https://swagger.io/resources/open-api/"
    }
}`

// SwaggerInfo holds exported Swagger Info so clients can modify it
var SwaggerInfo = &amp;swag.Spec{
        Version:          "1.0",
        Host:             "localhost:8080",
        BasePath:         "/",
        Schemes:          []string{},
        Title:            "Context Awareness Manager API",
        Description:      "This is the Context Awareness Manager service API for Docker context management.",
        InfoInstanceName: "swagger",
        SwaggerTemplate:  docTemplate,
        LeftDelim:        "{{",
        RightDelim:       "}}",
}

func init() <span class="cov8" title="1">{
        swag.Register(SwaggerInfo.InstanceName(), SwaggerInfo)
}</span>
</pre>
		
		<pre class="file" id="file3" style="display: none">/*
COLMENA-DESCRIPTION-SERVICE
Copyright © 2024 EVIDEN

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

This work has been implemented within the context of COLMENA project.
*/
package monitor

import (
        "bytes"
        "context-awareness-manager/internal/models"
        "database/sql"
        "encoding/json"
        "fmt"
        "log"
        "net/http"
        "os"
        "time"
)

// GetContextData check if DockerContextDefinitions table has data and return imageID list
func GetContextData(db *sql.DB) ([]models.DockerContextDefinition, error) <span class="cov8" title="1">{
        rows, err := db.Query("SELECT id, imageId FROM DockerContextDefinitions")
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("failed to query DockerContextDefinitions table: %v", err)
        }</span>
        <span class="cov8" title="1">defer rows.Close()

        var contextList []models.DockerContextDefinition
        for rows.Next() </span><span class="cov8" title="1">{
                var context models.DockerContextDefinition
                if err := rows.Scan(&amp;context.ID, &amp;context.ImageID); err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("failed to scan row: %v", err)
                }</span>
                <span class="cov8" title="1">contextList = append(contextList, context)</span>
        }
        <span class="cov8" title="1">if err := rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("row iteration error: %v", err)
        }</span>
        <span class="cov8" title="1">return contextList, nil</span>
}

func DeployContainer(image string, cmd []string) (string, error) <span class="cov8" title="1">{
        // Retrieve the destination URL from an environment variable
        destinationURL := os.Getenv("DOCKERENGINE_URL")
        if destinationURL == "" </span><span class="cov0" title="0">{
                log.Fatal("DOCKERENGINE_URL environment variable is not set")
        }</span>
        // Build the request
        <span class="cov8" title="1">requestBody := models.DeployRequest{
                Image: image,
                Cmd:   cmd,
        }

        jsonBody, err := json.Marshal(requestBody)
        if err != nil </span><span class="cov0" title="0">{
                return "", fmt.Errorf("error marshalling JSON request: %v", err)
        }</span>

        // Make the HTTP POST request to the microservice
        <span class="cov8" title="1">resp, err := http.Post(destinationURL, "application/json", bytes.NewBuffer(jsonBody))
        if err != nil </span><span class="cov0" title="0">{
                return "", fmt.Errorf("error making HTTP POST request: %v", err)
        }</span>
        <span class="cov8" title="1">defer resp.Body.Close()

        // Process the response
        var response models.DeployResponse
        err = json.NewDecoder(resp.Body).Decode(&amp;response)
        if err != nil </span><span class="cov0" title="0">{
                return "", fmt.Errorf("error decoding JSON response: %v", err)
        }</span>

        <span class="cov8" title="1">if response.Error != "" </span><span class="cov0" title="0">{
                return "", fmt.Errorf("deployment error: %s", response.Error)
        }</span>

        <span class="cov8" title="1">return response.Classification, nil</span>
}

// MonitorContext makes the HTTP POST request and compare the results
func MonitorContext(interval time.Duration, contextList []models.DockerContextDefinition, resultChannel chan models.Result) <span class="cov8" title="1">{
        var lastResults = make(map[string]string)

        for </span><span class="cov8" title="1">{
                for _, context := range contextList </span><span class="cov8" title="1">{
                        currentClassification, err := DeployContainer(context.ImageID, nil)
                        if err != nil </span><span class="cov0" title="0">{
                                log.Printf("Error deploying container: %v\n", err)
                                continue</span>
                        }

                        <span class="cov8" title="1">if lastResult, ok := lastResults[context.ImageID]; !ok || currentClassification != lastResult </span><span class="cov8" title="1">{
                                log.Printf("Context classification: %s\n", currentClassification)
                                resultChannel &lt;- models.Result{ID: context.ID, Classification: currentClassification}
                                lastResults[context.ImageID] = currentClassification
                        }</span>

                        <span class="cov8" title="1">time.Sleep(interval)</span>
                }
        }
}

// PublishContext sends an HTTP PUT request to the specified URL with a JSON body
// containing the provided value. The function takes two string parameters: `url` and `value`.
// It returns an error if the PUT request fails or if the response status code is not 200 OK.
func PublishContext(key string, value string) error <span class="cov8" title="1">{
        // Construct the URL using the provided key
        zenohURL := os.Getenv("ZENOH_URL")
        if zenohURL == "" </span><span class="cov0" title="0">{
                zenohURL = "http://zenoh:8000"
        }</span>
        <span class="cov8" title="1">url := fmt.Sprintf("%s/%s", zenohURL, key)

        // Create the JSON body with the provided value
        data := map[string]string{"value": value}
        jsonData, err := json.Marshal(data)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("error converting data to JSON: %v", err)
        }</span>

        <span class="cov8" title="1">log.Printf("Send %s to %s", jsonData, url)

        // Create a new HTTP PUT request
        req, err := http.NewRequest(http.MethodPut, url, bytes.NewBuffer(jsonData))
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("error creating PUT request: %v", err)
        }</span>

        // Set the Content-Type header to application/json
        <span class="cov8" title="1">req.Header.Set("Content-Type", "application/json")

        // Send the HTTP PUT request
        client := &amp;http.Client{}
        resp, err := client.Do(req)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("error sending PUT request: %v", err)
        }</span>
        <span class="cov8" title="1">defer resp.Body.Close()

        // Check if the response status code is 200 OK
        if resp.StatusCode != http.StatusOK </span><span class="cov0" title="0">{
                return fmt.Errorf("request failed with status code: %d", resp.StatusCode)
        }</span>

        <span class="cov8" title="1">return nil</span>
}
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
